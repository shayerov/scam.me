<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wait</title>
  <style>
    :root { --bg:#0f1226; --fg:#eef2ff; --muted:#a5b4fc; --card:#1b1f3a; --accent:#7c3aed; --ok:#34d399; }
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 600px at 20% 10%, #1c1f3f, transparent),
                 radial-gradient(900px 500px at 80% 90%, #171a33, transparent), var(--bg);
      color:var(--fg); display:grid; place-items:center;
    }
    .wrap{width:min(900px,92vw); padding:28px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px; padding:24px; box-shadow:0 20px 40px rgba(0,0,0,.25);
    }
    h1{margin:0 0 10px; font-size:clamp(1.6rem, 3vw, 2.2rem)}
    .lead{color:var(--muted); margin:0 0 18px}
    .pill{display:inline-block; padding:.2rem .6rem; border-radius:999px; background:rgba(255,255,255,.08); color:var(--muted); font-size:.9rem}
    .timer{font-variant-numeric:tabular-nums; font-weight:900; text-align:center;
      font-size:clamp(2.8rem, 10vw, 6rem); margin:10px 0 8px;}
    .sub{text-align:center; color:var(--muted); margin:0 0 16px}
    .progress{height:10px; background:rgba(255,255,255,.08); border-radius:12px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #06b6d4); transition:width .2s linear;}
    .done{display:none; text-align:center; margin-top:10px}
    .done h2{margin:8px 0 4px}
    .thanks{color:var(--ok); font-weight:900}
    .totals{margin-top:18px; padding:14px 16px; background:var(--card); border-radius:14px;
      border:1px solid rgba(255,255,255,.08);}
    .totals .label{color:var(--muted)}
    .totals .value{font-weight:900}
    footer{margin-top:16px; text-align:center; color:var(--muted); font-size:.9rem}
    code{background:rgba(255,255,255,.08); padding:.15rem .35rem; border-radius:.35rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>‚è≥ A Tiny Waiting Room</h1>
    <p class="lead">
      Event: <span class="pill" id="eventNamePill">‚Äî</span><br/>
      A random countdown between 30 seconds and 5 minutes. When it finishes, you‚Äôll see a thank-you ‚Äî and we‚Äôll add your seconds to the event total.
    </p>

    <section class="card" aria-live="polite">
      <div class="timer" id="timeLeft">00:00</div>
      <p class="sub" id="subtext">Counting down‚Ä¶</p>
      <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>

      <div class="done" id="done">
        <h2 class="thanks">Thank you for waiting üôè</h2>
        <p class="sub">You personally waited <span id="youWaited">0</span> seconds.</p>
        <p class="sub">Total for this event: <b><span id="eventTotal">‚Äî</span></b> seconds</p>
      </div>

      <div class="totals">
        <span class="label">Live total seconds (this event):</span>
        <span class="value" id="eventTotalLive">‚Äî</span>
      </div>

      <footer>
        URL format: <code>?event_name=scam-me</code>
      </footer>
    </section>
  </div>

  <!-- Firebase (Compat builds for easy drop-in) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <script>
    // ========= 1) Read event_name from URL =========
    const params = new URLSearchParams(location.search);
    const rawEvent = params.get('event_name') || 'default';

    // Keep it ‚Äúpath-safe‚Äù for Firebase keys
    const eventName = rawEvent.trim().toLowerCase().replace(/[^a-z0-9-_]/g, '-').slice(0, 64) || 'default';
    document.getElementById('eventNamePill').textContent = eventName;

    // ========= 2) Random timer =========
    const minMs = 30_000, maxMs = 300_000;
    const durationMs = Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
    const endAt = Date.now() + durationMs;

    // ========= UI =========
    const elTime = document.getElementById('timeLeft');
    const elSub = document.getElementById('subtext');
    const elBar = document.getElementById('bar');
    const elDone = document.getElementById('done');
    const elYou = document.getElementById('youWaited');
    const elEventTotalLive = document.getElementById('eventTotalLive');
    const elEventTotal = document.getElementById('eventTotal');

    function fmt(ms) {
      const s = Math.max(0, Math.ceil(ms / 1000));
      const m = Math.floor(s / 60);
      const r = String(s % 60).padStart(2, '0');
      return `${String(m).padStart(2,'0')}:${r}`;
    }

    // ========= 3) Firebase config (paste yours) =========
	// For Firebase JS SDK v7.20.0 and later, measurementId is optional
	const firebaseConfig = {
	  apiKey: "AIzaSyBjgXGvkvTtmLCKgCq_AuX3NHFu-P4TljU",
	  authDomain: "scam-me-12e45.firebaseapp.com",
	  projectId: "scam-me-12e45",
	  storageBucket: "scam-me-12e45.firebasestorage.app",
	  messagingSenderId: "541965900648",
	  appId: "1:541965900648:web:bc2c8a36da68ffc1a2d4dd",
	  measurementId: "G-E745Z03SRT"
	};

    // ========= 4) Database refs =========
    let firebaseReady = false;
    let sessionRef = null;         // /sessions/{pushId}
    let eventTotalRef = null;      // /events/{eventName}/totalSeconds
    let sessionId = null;

    // Session state we store:
    // { event_name, total_waiting, didFinish, createdAt }
    let visible = document.visibilityState === 'visible';
    let youWaitedSeconds = 0;
    let bufferedSeconds = 0;
    let lastFlushedSessionTotal = 0;
    let finished = false;

    function initFirebase() {
      if (!firebaseConfig.apiKey) return;

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Create a unique session entry
      const sessions = db.ref('sessions');
      sessionRef = sessions.push();
      sessionId = sessionRef.key;

      eventTotalRef = db.ref(`events/${eventName}/totalSeconds`);

      firebaseReady = true;

      // Write initial session record
      sessionRef.set({
        event_name: eventName,
        total_waiting: 0,
        didFinish: false,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });

      // Live total for this event
      eventTotalRef.on('value', snap => {
        const v = snap.val();
        elEventTotalLive.textContent = (typeof v === 'number' ? v : 0).toLocaleString();
      }, () => {
        elEventTotalLive.textContent = '‚Äî';
      });
    }

    try { initFirebase(); } catch (e) {
      console.warn('Firebase not initialized (demo mode).', e);
    }

    // ========= 5) Flush seconds to DB (batched) =========
    async function flush() {
      if (!firebaseReady || !sessionRef || !eventTotalRef || bufferedSeconds <= 0) return;

      const delta = bufferedSeconds;
      bufferedSeconds = 0;

      // Update session total_waiting (monotonic)
      lastFlushedSessionTotal += delta;

      try {
        // 1) Increment aggregate event total
        await eventTotalRef.transaction(cur => (typeof cur === 'number' ? cur : 0) + delta);

        // 2) Update the session record
        await sessionRef.update({
          total_waiting: lastFlushedSessionTotal
        });
      } catch (e) {
        // If it fails, re-buffer and try later
        bufferedSeconds += delta;
        lastFlushedSessionTotal -= delta;
      }
    }

    // Count only while visible, flush every 5 seconds
    let sinceFlush = 0;
    setInterval(() => {
      if (finished) return;
      if (!visible) return;

      youWaitedSeconds += 1;
      bufferedSeconds += 1;
      sinceFlush += 1;

      if (sinceFlush >= 5) { sinceFlush = 0; flush(); }
    }, 1000);

    document.addEventListener('visibilitychange', () => {
      visible = document.visibilityState === 'visible';
      if (!visible) flush();
    });

    window.addEventListener('beforeunload', () => { flush(); });

    // ========= 6) Countdown =========
    const tick = () => {
      const msLeft = Math.max(0, endAt - Date.now());
      elTime.textContent = fmt(msLeft);
      elBar.style.width = (100 - (msLeft / durationMs) * 100).toFixed(2) + '%';

      if (msLeft <= 0 && !finished) {
        finished = true;
        elSub.textContent = 'Done!';
        elDone.style.display = 'block';
        elYou.textContent = youWaitedSeconds.toLocaleString();

        // Final flush + mark didFinish true
        (async () => {
          await flush();
          if (firebaseReady && sessionRef) {
            try {
              await sessionRef.update({ didFinish: true });
            } catch {}
          }

          // Show event total at end (read current live total)
          const current = elEventTotalLive.textContent;
          elEventTotal.textContent = current === '‚Äî' ? '0' : current.replace(/,/g,'');
          // (We also leave the formatted live one visible above.)
          elEventTotal.textContent = (parseInt(elEventTotal.textContent,10) || 0).toLocaleString();
        })();

        clearInterval(ticker);
      }
    };

    const ticker = setInterval(tick, 200);
    tick();
  </script>
</body>
</html>
