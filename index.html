<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wait</title>
  <style>
    :root { --bg:#0f1226; --fg:#eef2ff; --muted:#a5b4fc; --card:#1b1f3a; --accent:#7c3aed; --ok:#34d399; }
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 600px at 20% 10%, #1c1f3f, transparent),
                 radial-gradient(900px 500px at 80% 90%, #171a33, transparent), var(--bg);
      color:var(--fg); display:grid; place-items:center;
    }
    .wrap{width:min(900px,92vw); padding:28px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px; padding:24px; box-shadow:0 20px 40px rgba(0,0,0,.25);
    }
    h1{margin:0 0 10px; font-size:clamp(1.6rem, 3vw, 2.2rem)}
    .lead{color:var(--muted); margin:0 0 18px}
    .timer{font-variant-numeric:tabular-nums; font-weight:900; text-align:center;
      font-size:clamp(2.8rem, 10vw, 6rem); margin:10px 0 8px;}
    .sub{text-align:center; color:var(--muted); margin:0 0 16px}
    .progress{height:10px; background:rgba(255,255,255,.08); border-radius:12px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #06b6d4); transition:width .2s linear;}
    .done{display:none; text-align:center; margin-top:10px}
    .done h2{margin:8px 0 4px}
    .thanks{color:var(--ok); font-weight:900}
    .totals{margin-top:18px; padding:14px 16px; background:var(--card); border-radius:14px;
      border:1px solid rgba(255,255,255,.08);}
    .totals .label{color:var(--muted)}
    .totals .value{font-weight:900}
    footer{margin-top:16px; text-align:center; color:var(--muted); font-size:.9rem}
    code{background:rgba(255,255,255,.08); padding:.15rem .35rem; border-radius:.35rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>‚è≥ A Tiny Waiting Room</h1>
    <p class="lead">A random countdown between 30 seconds and 5 minutes. When it finishes, you‚Äôll see a thank-you ‚Äî and we‚Äôll add your seconds to the global total.</p>

    <section class="card" aria-live="polite">
      <div class="timer" id="timeLeft">00:00</div>
      <p class="sub" id="subtext">Counting down‚Ä¶</p>

      <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>

      <div class="done" id="done">
        <h2 class="thanks">Thank you for waiting üôè</h2>
        <p class="sub">You personally waited <span id="youWaited">0</span> seconds.</p>
      </div>

      <div class="totals">
        <span class="label">Total seconds waited by everyone:</span>
        <span class="value" id="globalTotal">‚Äî</span>
      </div>

      <footer>
        Global total uses Firebase Realtime Database. Paste your config into <code>firebaseConfig</code>.
      </footer>
    </section>
  </div>

  <!-- Firebase (drop-in simple builds) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <script>
    // ======== Random timer (30s..5m) ========
    const minMs = 30_000, maxMs = 300_000;
    const durationMs = Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
    const startedAt = Date.now();
    const endAt = startedAt + durationMs;

    // ======== UI ========
    const elTime = document.getElementById('timeLeft');
    const elSub = document.getElementById('subtext');
    const elBar = document.getElementById('bar');
    const elDone = document.getElementById('done');
    const elYou = document.getElementById('youWaited');
    const elGlobal = document.getElementById('globalTotal');

    function fmt(ms) {
      const s = Math.max(0, Math.ceil(ms / 1000));
      const m = Math.floor(s / 60);
      const r = String(s % 60).padStart(2, '0');
      return `${String(m).padStart(2,'0')}:${r}`;
    }

    // ======== Firebase (global total) ========
    // Create a Firebase project + Realtime Database, then paste your config here:
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
    };

    let totalRef = null;
    let firebaseReady = false;

    try {
      if (firebaseConfig.apiKey && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        totalRef = db.ref('totalSeconds');
        firebaseReady = true;

        // Live readout
        totalRef.on('value', snap => {
          const v = snap.val();
          elGlobal.textContent = (typeof v === 'number' ? v : 0).toLocaleString();
        }, () => { elGlobal.textContent = '‚Äî'; });
      }
    } catch (e) {
      console.warn('Firebase not initialized (local/demo mode).', e);
    }

    // ======== Count seconds while tab is visible ========
    let visible = document.visibilityState === 'visible';
    let youWaitedSeconds = 0;
    let bufferedSeconds = 0;

    async function flush() {
      if (!firebaseReady || !totalRef || bufferedSeconds <= 0) return;
      const delta = bufferedSeconds;
      bufferedSeconds = 0;
      try {
        await totalRef.transaction(cur => (typeof cur === 'number' ? cur : 0) + delta);
      } catch (e) {
        bufferedSeconds += delta; // retry later
      }
    }

    // Add 1s per second while visible, flush every 5s
    let sinceFlush = 0;
    setInterval(() => {
      if (!visible) return;
      youWaitedSeconds += 1;
      bufferedSeconds += 1;
      sinceFlush += 1;
      if (sinceFlush >= 5) { sinceFlush = 0; flush(); }
    }, 1000);

    document.addEventListener('visibilitychange', () => {
      visible = document.visibilityState === 'visible';
      if (!visible) flush();
    });

    window.addEventListener('beforeunload', () => { flush(); });

    // ======== Countdown ========
    const tick = () => {
      const now = Date.now();
      const msLeft = Math.max(0, endAt - now);
      elTime.textContent = fmt(msLeft);
      elBar.style.width = (100 - (msLeft / durationMs) * 100).toFixed(2) + '%';

      if (msLeft <= 0) {
        elSub.textContent = 'Done!';
        elDone.style.display = 'block';
        elYou.textContent = youWaitedSeconds.toLocaleString();
        clearInterval(ticker);
        flush(); // final flush
      }
    };

    const ticker = setInterval(tick, 200);
    tick();

    // ======== Realtime DB Rules (paste in Firebase Console > Realtime Database > Rules) ========
    /*
    {
      "rules": {
        ".read": true,
        "totalSeconds": {
          ".write": "newData.isNumber() && (data.val() === null || newData.val() >= data.val())"
        }
      }
    }
    */
  </script>
</body>
</html>
