<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Wait</title>

  <style>
    :root { --bg:#0f1226; --fg:#eef2ff; --muted:#a5b4fc; --card:#1b1f3a; --accent:#7c3aed; --ok:#34d399; --bad:#fb7185; }
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 600px at 20% 10%, #1c1f3f, transparent),
                 radial-gradient(900px 500px at 80% 90%, #171a33, transparent), var(--bg);
      color:var(--fg); display:grid; place-items:center;
    }
    .wrap{width:min(900px,92vw); padding:28px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px; padding:24px;
      box-shadow:0 20px 40px rgba(0,0,0,.25);
    }
    h1{margin:0 0 10px}
    .pill{padding:.2rem .6rem; border-radius:999px; background:rgba(255,255,255,.08)}
    .timer{font-size:clamp(3rem,10vw,6rem); font-weight:900; text-align:center}
    .progress{height:10px; background:rgba(255,255,255,.08); border-radius:12px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#06b6d4)}
    .done{display:none; text-align:center}
    .btnRow{margin-top:16px; display:flex; justify-content:center}
    button{
      background:rgba(255,255,255,.06); color:var(--fg);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 16px; border-radius:12px; font-weight:700;
      cursor:pointer;
    }
    button[disabled]{opacity:.5}
    #blocked{display:none; text-align:center}
    #blocked p{color:var(--bad)}
  </style>
</head>

<body>
<div class="wrap">
  <h1>‚è≥ A Tiny Waiting Room</h1>
  <p>Event: <span class="pill" id="eventLabel">‚Äî</span></p>

  <section class="card">
    <div id="blocked">
      <h2>üö´ Not active</h2>
      <p id="blockedReason"></p>
    </div>

    <div id="active">
      <div class="timer" id="timer">--:--</div>
      <p id="status">Connecting‚Ä¶</p>
      <div class="progress"><div class="bar" id="bar"></div></div>

      <div class="done" id="done">
        <h2>Thank you for waiting üôè</h2>
        <p>You waited <b><span id="youWaited">0</span></b> seconds</p>
        <p>Total for this event: <b><span id="eventTotal">‚Äî</span></b> seconds</p>
      </div>

      <div class="btnRow">
        <button id="minus30">‚àí 30 seconds</button>
      </div>
    </div>
  </section>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBjgXGvkvTtmLCKgCq_AuX3NHFu-P4TljU",
  authDomain: "scam-me-12e45.firebaseapp.com",
  databaseURL: "https://scam-me-12e45-default-rtdb.firebaseio.com",
  projectId: "scam-me-12e45",
  storageBucket: "scam-me-12e45.firebasestorage.app",
  messagingSenderId: "541965900648",
  appId: "1:541965900648:web:bc2c8a36da68ffc1a2d4dd"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= Event ================= */
const params = new URLSearchParams(location.search);
const eventName = (params.get('event_name') || '').toLowerCase();
document.getElementById('eventLabel').textContent = eventName || '‚Äî';

const blocked = document.getElementById('blocked');
const blockedReason = document.getElementById('blockedReason');
const active = document.getElementById('active');

function block(msg){
  blocked.style.display = 'block';
  active.style.display = 'none';
  blockedReason.textContent = msg;
}

/* ================= Timer ================= */
const minMs = 30000, maxMs = 300000;
const storageKey = `wait_end_${eventName}`;

function getEndAt(){
  const now = Date.now();
  const saved = Number(localStorage.getItem(storageKey));
  if(saved && saved > now){
    const extended = saved + 30000;
    localStorage.setItem(storageKey, extended);
    return extended;
  }
  const dur = Math.floor(Math.random()*(maxMs-minMs))+minMs;
  const end = now + dur;
  localStorage.setItem(storageKey, end);
  return end;
}

let endAt = getEndAt();
let baseline = endAt - Date.now();
let finished = false;

/* ================= UI ================= */
const timerEl = document.getElementById('timer');
const bar = document.getElementById('bar');
const statusEl = document.getElementById('status');
const minus30 = document.getElementById('minus30');
const doneEl = document.getElementById('done');
const youWaitedEl = document.getElementById('youWaited');
const eventTotalEl = document.getElementById('eventTotal');

/* ================= DB ================= */
let sessionRef;
let totalRef;
let waited = 0;
let buffer = 0;
let visible = document.visibilityState === 'visible';

document.addEventListener('visibilitychange', () =>
  visible = document.visibilityState === 'visible'
);

/* ================= Start ================= */
(async function start(){
  if(!eventName){ block('Missing ?event_name'); return; }

  const eventRef = db.ref(`events/${eventName}`);
  const snap = await eventRef.get();

  if(!snap.exists()){ block('Event does not exist'); return; }
  if(snap.val().done === true){ block('Event already finished'); return; }

  if(typeof snap.val().totalSeconds !== 'number'){
    await eventRef.update({ totalSeconds: 0, done:false });
  }

  totalRef = eventRef.child('totalSeconds');

  sessionRef = db.ref('sessions').push();
  await sessionRef.set({
    event_name:eventName,
    total_waiting:0,
    didFinish:false,
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });

  statusEl.textContent = 'Counting down‚Ä¶';

  setInterval(()=>{
    if(!finished && visible){
      waited++; buffer++;
    }
  },1000);

  setInterval(async ()=>{
    if(buffer>0){
      const d = buffer; buffer = 0;
      await totalRef.transaction(v => (v||0)+d);
      await sessionRef.update({ total_waiting: waited });
    }
  },5000);

  setInterval(async ()=>{
    if(finished) return;
    const left = Math.max(0, endAt-Date.now());
    timerEl.textContent =
      `${String(Math.floor(left/60000)).padStart(2,'0')}:${String(Math.ceil(left/1000)%60).padStart(2,'0')}`;
    bar.style.width = `${100-(left/baseline)*100}%`;

    if(left<=0){
      finished = true;
      await sessionRef.update({ didFinish:true });
      youWaitedEl.textContent = waited;
      const totalSnap = await totalRef.get();
      eventTotalEl.textContent = totalSnap.val();
      doneEl.style.display='block';
      minus30.disabled=true;
    }
  },200);
})();

minus30.onclick = ()=>{
  if(finished) return;
  endAt -= 30000;
  localStorage.setItem(storageKey,endAt);
};
</script>
</body>
</html>
